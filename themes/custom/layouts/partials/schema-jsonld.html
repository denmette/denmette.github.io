{{- $nodes := slice -}}

{{- $siteURL := .Site.BaseURL -}}
{{- if not (hasPrefix $siteURL "http") -}}
  {{- $siteURL = $siteURL | absURL -}}
{{- end -}}
{{- $siteTitle := .Site.Title | default "Site" -}}
{{- $orgId := printf "%s#org" $siteURL -}}
{{- $websiteId := printf "%s#website" $siteURL -}}
{{- $blogId := printf "%s#blog" $siteURL -}}
{{- $logoId := printf "%s#logo" $siteURL -}}

{{- $logoURL := .Site.Params.avatar -}}
{{- if $logoURL -}}
  {{- if not (hasPrefix $logoURL "http") -}}
    {{- $logoURL = $logoURL | absURL -}}
  {{- end -}}
{{- end -}}

{{- $person := .Site.Params.person -}}
{{- $personName := $person.name | default .Site.Params.author -}}
{{- $personId := $person.id | default (printf "%s#maarten-casteels" $siteURL) -}}
{{- if not (hasPrefix $personId "http") -}}
  {{- $personId = $personId | absURL -}}
{{- end -}}
{{- $personURL := $person.url | default $siteURL -}}
{{- if not (hasPrefix $personURL "http") -}}
  {{- $personURL = $personURL | absURL -}}
{{- end -}}
{{- $personImage := $person.image | default .Site.Params.avatar -}}
{{- if $personImage -}}
  {{- if not (hasPrefix $personImage "http") -}}
    {{- $personImage = $personImage | absURL -}}
  {{- end -}}
{{- end -}}
{{- $sameAs := $person.sameAs | default .Site.Params.sameAs -}}
{{- $sameAsList := slice -}}
{{- if $sameAs -}}
  {{- range $sameAs -}}
    {{- $item := . -}}
    {{- if not (hasPrefix $item "http") -}}
      {{- $item = $item | absURL -}}
    {{- end -}}
    {{- if and $item (ne $item "https://denmette.be") (ne $item "https://denmette.be/") -}}
      {{- $sameAsList = $sameAsList | append $item -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $worksFor := $person.worksFor -}}
{{- $worksForNode := dict -}}
{{- if $worksFor -}}
  {{- $worksForURL := $worksFor.url -}}
  {{- if $worksForURL -}}
    {{- if not (hasPrefix $worksForURL "http") -}}
      {{- $worksForURL = $worksForURL | absURL -}}
    {{- end -}}
  {{- end -}}
  {{- $worksForNode = dict "@type" "Organization" "name" $worksFor.name -}}
  {{- if $worksForURL -}}
    {{- $worksForNode = merge $worksForNode (dict "url" $worksForURL) -}}
  {{- end -}}
{{- end -}}
{{- $memberOf := $person.memberOf -}}
{{- $memberOfNodes := slice -}}
{{- if $memberOf -}}
  {{- range $memberOf -}}
    {{- $memberOrgId := .id -}}
    {{- if $memberOrgId -}}
      {{- if not (hasPrefix $memberOrgId "http") -}}
        {{- $memberOrgId = $memberOrgId | absURL -}}
      {{- end -}}
    {{- end -}}
    {{- $memberOrgURL := .url -}}
    {{- if $memberOrgURL -}}
      {{- if not (hasPrefix $memberOrgURL "http") -}}
        {{- $memberOrgURL = $memberOrgURL | absURL -}}
      {{- end -}}
    {{- end -}}
    {{- $memberOrgNode := dict
      "@type" "Organization"
      "name" .name
    -}}
    {{- if $memberOrgId -}}
      {{- $memberOrgNode = merge $memberOrgNode (dict "@id" $memberOrgId) -}}
    {{- end -}}
    {{- if $memberOrgURL -}}
      {{- $memberOrgNode = merge $memberOrgNode (dict "url" $memberOrgURL) -}}
    {{- end -}}
    {{- if .roleName -}}
      {{- $memberOrgNode = merge $memberOrgNode (dict "member" (dict "@type" "Role" "roleName" .roleName)) -}}
    {{- end -}}
    {{- $memberOfNodes = $memberOfNodes | append $memberOrgNode -}}
  {{- end -}}
{{- end -}}

{{- $orgNode := dict
  "@type" "Organization"
  "@id" $orgId
  "name" $siteTitle
  "url" $siteURL
-}}
{{- if $logoURL -}}
  {{- $orgNode = merge $orgNode (dict "logo" (dict "@type" "ImageObject" "@id" $logoId "url" $logoURL)) -}}
{{- end -}}
{{- if $personName -}}
  {{- $orgNode = merge $orgNode (dict "founder" (dict "@id" $personId)) -}}
{{- end -}}
{{- $nodes = $nodes | append $orgNode -}}

{{- $website := dict
  "@type" "WebSite"
  "@id" $websiteId
  "name" $siteTitle
  "url" $siteURL
  "publisher" (dict "@id" $orgId)
-}}
{{- $nodes = $nodes | append $website -}}

{{- $siteDescription := .Site.Params.descriptionLong | default .Site.Params.description -}}
{{- $blogNode := dict
  "@type" "Blog"
  "@id" $blogId
  "name" $siteTitle
  "url" $siteURL
  "isPartOf" (dict "@id" $websiteId)
  "publisher" (dict "@id" $orgId)
-}}
{{- if $siteDescription -}}
  {{- $blogNode = merge $blogNode (dict "description" $siteDescription) -}}
{{- end -}}
{{- if $personName -}}
  {{- $blogNode = merge $blogNode (dict "author" (dict "@id" $personId)) -}}
{{- end -}}
{{- $languageCode := .Site.Language.LanguageCode | default .Site.Language.Lang | default .Site.LanguageCode -}}
{{- if $languageCode -}}
  {{- $blogNode = merge $blogNode (dict "inLanguage" $languageCode) -}}
{{- end -}}
{{- $nodes = $nodes | append $blogNode -}}

{{- if $personName -}}
  {{- $personNode := dict
    "@type" "Person"
    "@id" $personId
    "name" $personName
    "url" $personURL
  -}}
  {{- if $personImage -}}
    {{- $personNode = merge $personNode (dict "image" $personImage) -}}
  {{- end -}}
  {{- if gt (len $sameAsList) 0 -}}
    {{- $personNode = merge $personNode (dict "sameAs" $sameAsList) -}}
  {{- end -}}
  {{- if $worksFor -}}
    {{- $personNode = merge $personNode (dict "worksFor" $worksForNode) -}}
  {{- end -}}
  {{- if gt (len $memberOfNodes) 0 -}}
    {{- $personNode = merge $personNode (dict "memberOf" $memberOfNodes) -}}
  {{- end -}}
  {{- $nodes = $nodes | append $personNode -}}
{{- end -}}

{{- $pageURL := .Permalink -}}
{{- $webpageId := printf "%s#webpage" $pageURL -}}
{{- $webpageName := .Title | default $siteTitle -}}
{{- $isPostList := or .IsHome (and (eq .Kind "section") (eq .Section "posts")) -}}
{{- $webpageType := "WebPage" -}}
{{- if $isPostList -}}
  {{- $webpageType = "CollectionPage" -}}
{{- end -}}
{{- $webpageNode := dict
  "@type" $webpageType
  "@id" $webpageId
  "url" $pageURL
  "name" $webpageName
  "isPartOf" (dict "@id" $websiteId)
-}}
{{- if $languageCode -}}
  {{- $webpageNode = merge $webpageNode (dict "inLanguage" $languageCode) -}}
{{- end -}}

{{- if $isPostList -}}
  {{- $pageSize := 5 -}}
  {{- $posts := where .Site.RegularPages "Section" "posts" -}}
  {{- $paginator := .Paginate $posts $pageSize -}}
  {{- $listPages := $paginator.Pages -}}
  {{- if gt (len $listPages) 0 -}}
    {{- $itemListId := printf "%s#itemlist" $pageURL -}}
    {{- $itemListElements := slice -}}
    {{- range $index, $page := $listPages -}}
      {{- $itemListElements = $itemListElements | append (dict
        "@type" "ListItem"
        "position" (add $index 1)
        "item" (dict "@id" $page.Permalink "name" $page.Title)
      ) -}}
    {{- end -}}
    {{- $itemListNode := dict
      "@type" "ItemList"
      "@id" $itemListId
      "itemListElement" $itemListElements
      "numberOfItems" (len $listPages)
    -}}
    {{- $webpageNode = merge $webpageNode (dict "mainEntity" (dict "@id" $itemListId)) -}}
    {{- $nodes = $nodes | append $itemListNode -}}
  {{- end -}}
{{- end -}}

{{- if and .IsPage (eq .Section "posts") -}}
  {{- $imageURL := "" -}}
  {{- with .Params.cover.image -}}
    {{- with $.Resources.GetMatch . -}}
      {{- $imageURL = .Permalink -}}
    {{- else -}}
      {{- $imageURL = . -}}
    {{- end -}}
  {{- end -}}
  {{- if $imageURL -}}
    {{- if not (hasPrefix $imageURL "http") -}}
      {{- $imageURL = $imageURL | absURL -}}
    {{- end -}}
  {{- end -}}
  {{- $hasModified := and .Lastmod (gt (sub .Lastmod.Unix .Date.Unix) 86400) -}}
  {{- $blogPosting := dict
    "@type" "BlogPosting"
    "@id" (printf "%s#article" .Permalink)
    "headline" .Title
    "datePublished" (.Date.Format "2006-01-02T15:04:05Z07:00")
    "mainEntityOfPage" (dict "@id" $webpageId)
    "isPartOf" (dict "@id" $blogId)
    "publisher" (dict "@id" $orgId)
  -}}
  {{- $postDescription := .Params.description | default .Summary -}}
  {{- if $postDescription -}}
    {{- $blogPosting = merge $blogPosting (dict "description" ($postDescription | plainify | htmlUnescape)) -}}
  {{- end -}}
  {{- with .Params.tags -}}
    {{- if gt (len .) 0 -}}
      {{- $blogPosting = merge $blogPosting (dict "keywords" .) -}}
    {{- end -}}
  {{- end -}}
  {{- if $personName -}}
    {{- $blogPosting = merge $blogPosting (dict "author" (dict "@id" $personId)) -}}
  {{- end -}}
  {{- if $hasModified -}}
    {{- $blogPosting = merge $blogPosting (dict "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")) -}}
  {{- end -}}
  {{- if $imageURL -}}
    {{- $imageObject := dict "@type" "ImageObject" "url" $imageURL -}}
    {{- with .Params.cover.image -}}
      {{- with $.Resources.GetMatch . -}}
        {{- $imageObject = merge $imageObject (dict "width" .Width "height" .Height) -}}
      {{- end -}}
    {{- end -}}
    {{- $blogPosting = merge $blogPosting (dict "image" $imageObject) -}}
  {{- end -}}
  {{- $webpageNode = merge $webpageNode (dict "mainEntity" (dict "@id" (printf "%s#article" .Permalink))) -}}
  {{- $nodes = $nodes | append $blogPosting -}}
{{- end -}}

{{- $nodes = $nodes | append $webpageNode -}}

{{- $graph := dict
  "@context" "https://schema.org"
  "@graph" $nodes
-}}
<script type="application/ld+json">{{ $graph | jsonify | safeJS }}</script>
